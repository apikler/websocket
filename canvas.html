<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

<canvas 
    id="canvas" 
    width="0" 
    height="0" 
    style="position:absolute; top: 0px; left: 0px" 
    onmousedown="mouseDown(event);"
    onmouseup="mouseUp(event);"
    onmousemove="mouseMove(event);"
></canvas>

<script type="text/javascript">
var is_mouse_down = false;
var last_coords = null;
var websocket = null;

function context() {
    return document.getElementById("canvas").getContext("2d");
}

function dot(x, y) {
    var ctx = context();
    ctx.beginPath();
    ctx.arc(x, y, 3, 0, 2*Math.PI);
    ctx.fill();
}

function drawDots(x1, y1, x2, y2) {
    slope = (y2 - y1) / (x2 - x1);
    if (Math.abs(x2 - x1) > Math.abs(y2 - y1)) {
        for (var x = Math.min(x1, x2); x <= Math.max(x1, x2); x++) {
            dot(x, slope*(x - x1) + y1);
        }
    }
    else {
        for (var y = Math.min(y1, y2); y <= Math.max(y1, y2); y++) {
            dot((y - y1)/slope + x1, y);
        }
    }
}

function mouseDown(event) {
    last_coords = canvasCoords(event);
    dot(last_coords[0], last_coords[1]);
    is_mouse_down = true;
    sendCoords(event, "down");
}

function mouseUp(event) {
    is_mouse_down = false;
    offset = null;
    sendCoords(event, "up");
}

function mouseMove(event) {
    if (is_mouse_down) {
        var new_coords = canvasCoords(event);
        drawDots(last_coords[0], last_coords[1], new_coords[0], new_coords[1]);
        
        last_coords = new_coords;
        sendCoords(event, "move");
    }
}

function canvasCoords(event) {
    var offset = $("#canvas").offset();
    return [event.clientX - offset.left, event.clientY - offset.top];
}

function coordsToCartesian(x, y) {
    var new_x = x - $("#canvas").attr("width") / 2;
    var new_y = -y + $("#canvas").attr("height") / 2;
    return [new_x, new_y];
}

function sendCoords(event, event_name) {
    var coords = canvasCoords(event);
    var obj = {
        coords: coordsToCartesian(coords[0], coords[1]),
        event: event_name
    };
    websocket.send(JSON.stringify(obj));
}

function resizeCanvas() {
    $("#canvas").attr("width", window.innerWidth);
    $("#canvas").attr("height", window.innerHeight); 
}

$(window).bind("resize", function(){
    resizeCanvas();
});

$(function() {
    websocket = new WebSocket("ws://localhost:8888/");
    websocket.onopen = function(event) {
        resizeCanvas();
    };
    websocket.onclose = function(event) {
        $("#canvas").attr("width", 0);
        $("#canvas").attr("height", 0);
    };
});



</script>
